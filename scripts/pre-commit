#!/bin/bash
# Pre-commit hook for my-family
#
# Installation:
#   ln -sf ../../scripts/pre-commit .git/hooks/pre-commit
#
# Or manually:
#   cp scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

set -e

echo "Running pre-commit checks..."

# --- Tool Discovery: Find golangci-lint in multiple locations ---
if command -v golangci-lint &> /dev/null; then
  GOLANGCI_LINT="golangci-lint"
elif [ -x "$HOME/go/bin/golangci-lint" ]; then
  GOLANGCI_LINT="$HOME/go/bin/golangci-lint"
elif [ -x "$(go env GOPATH)/bin/golangci-lint" ]; then
  GOLANGCI_LINT="$(go env GOPATH)/bin/golangci-lint"
else
  echo "Error: golangci-lint not found in PATH, ~/go/bin, or GOPATH/bin"
  echo "Install with: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
  exit 1
fi

# --- Format Check ---
echo "→ Checking code formatting..."
UNFORMATTED=$(gofmt -l . | grep -v '^vendor/' || true)
if [ -n "$UNFORMATTED" ]; then
  echo "  ✗ The following files need formatting:"
  echo "$UNFORMATTED" | sed 's/^/    /'
  echo "  Run: go fmt ./..."
  exit 1
fi
echo "  ✓ Code formatting OK"

# --- Linting ---
echo "→ Running golangci-lint..."
if ! "$GOLANGCI_LINT" run --timeout=5m; then
  echo "  ✗ Linting failed"
  exit 1
fi
echo "  ✓ Linting passed"

# --- Vet ---
echo "→ Running go vet..."
if ! go vet ./...; then
  echo "  ✗ go vet failed"
  exit 1
fi
echo "  ✓ go vet passed"

# --- Tests ---
echo "→ Running tests..."
if ! go test ./...; then
  echo "  ✗ Tests failed"
  exit 1
fi
echo "  ✓ Tests passed"

# Note: Coverage threshold checks run in pre-push hook (faster commits)

# --- OpenAPI Code Generation Check ---
echo "→ Checking generated API code..."

# Check Go generated code
go generate ./internal/api/...
if ! git diff --quiet internal/api/generated.go 2>/dev/null; then
  echo "  ✗ Go API code is out of sync with OpenAPI spec"
  echo "  Run: make generate-api"
  echo "  Then: git add internal/api/generated.go"
  exit 1
fi
echo "  ✓ Go generated code OK"

# Check TypeScript generated types
cd web && npm run generate:types --silent
cd ..
if ! git diff --quiet web/src/lib/api/types.generated.ts 2>/dev/null; then
  echo "  ✗ TypeScript types are out of sync with OpenAPI spec"
  echo "  Run: make generate-types"
  echo "  Then: git add web/src/lib/api/types.generated.ts"
  exit 1
fi
echo "  ✓ TypeScript generated types OK"

echo ""
echo "✓ All pre-commit checks passed"
